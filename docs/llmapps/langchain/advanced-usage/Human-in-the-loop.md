# ğŸ§­ Human-in-the-Loopï¼ˆäººç±»åœ¨ç¯ï¼‰æ•™ç¨‹

## ä¸€ã€æ¦‚å¿µç®€ä»‹

åœ¨è‡ªåŠ¨åŒ–æ™ºèƒ½ç³»ç»Ÿä¸­ï¼Œæˆ‘ä»¬å¸Œæœ› AI å…·å¤‡å¼ºå¤§çš„è‡ªä¸»å†³ç­–èƒ½åŠ›ï¼Œä½†åœ¨ä¸€äº›å…³é”®æ“ä½œä¸Šï¼ˆä¾‹å¦‚åˆ é™¤æ•°æ®åº“è®°å½•ã€å†™å…¥æ–‡ä»¶ã€å‘é€é‚®ä»¶ï¼‰ï¼Œ**å®Œå…¨äº¤ç”±æ¨¡å‹è‡ªåŠ¨æ‰§è¡Œæ˜¯ä¸å®‰å…¨çš„**ã€‚
è¿™æ—¶å°±éœ€è¦ **Human-in-the-Loopï¼ˆHITLï¼‰** æœºåˆ¶ã€‚

**HITL ä¸­é—´ä»¶** å…è®¸ä½ åœ¨ Agent æ‰§è¡Œå·¥å…·è°ƒç”¨ï¼ˆTool Callï¼‰ä¹‹å‰ï¼Œæ’å…¥ä¸€ä¸ªäººå·¥å®¡æŸ¥ç¯èŠ‚ã€‚
å½“æ¨¡å‹è®¡åˆ’æ‰§è¡Œé«˜é£é™©æˆ–æ•æ„Ÿæ“ä½œæ—¶ï¼Œå®ƒä¼š**æš‚åœæ‰§è¡Œ**ï¼Œç­‰å¾…äººå·¥æ‰¹å‡†ã€ä¿®æ”¹æˆ–æ‹’ç»ã€‚

æ¢å¥è¯è¯´ï¼ŒHITL æ˜¯ AI ç³»ç»Ÿçš„**â€œå®‰å…¨é˜€â€** â€”â€” å®ƒè®©ä½ å†³å®šä½•æ—¶è®©äººç±»ä»‹å…¥ã€å¦‚ä½•æ¢å¤æ‰§è¡Œã€‚

---

## äºŒã€HITL çš„å·¥ä½œåŸç†

1. **æ¨¡å‹ç”Ÿæˆè®¡åˆ’**ï¼šAgent è¾“å‡ºä¸€ä¸ªå·¥å…·è°ƒç”¨è¯·æ±‚ï¼ˆä¾‹å¦‚æ‰§è¡Œ SQLï¼‰ã€‚
2. **ä¸­é—´ä»¶æ£€æŸ¥**ï¼šHITL ä¸­é—´ä»¶æ ¹æ®é¢„å…ˆè®¾å®šçš„ç­–ç•¥æ£€æŸ¥è¿™ä¸ªè°ƒç”¨ã€‚
3. **è§¦å‘ä¸­æ–­**ï¼šè‹¥è¯¥æ“ä½œéœ€è¦äººå·¥å¹²é¢„ï¼Œä¸­é—´ä»¶ä¼šå‘å‡ºä¸€ä¸ª *interruptï¼ˆä¸­æ–­ï¼‰* ä¿¡å·ï¼Œæš‚åœæ‰§è¡Œã€‚
4. **ä¿å­˜çŠ¶æ€**ï¼šå½“å‰å¯¹è¯çŠ¶æ€é€šè¿‡ LangGraph çš„æŒä¹…åŒ–å±‚ï¼ˆPersistence Layerï¼‰ä¿å­˜ã€‚
5. **äººå·¥å®¡æŸ¥**ï¼šäººç±»å¯ä»¥é€‰æ‹©ï¼š

   * âœ… `approve`ï¼ˆæ‰¹å‡†æ‰§è¡Œï¼‰
   * âœï¸ `edit`ï¼ˆä¿®æ”¹æ‰§è¡Œå‚æ•°ï¼‰
   * âŒ `reject`ï¼ˆæ‹’ç»å¹¶åé¦ˆåŸå› ï¼‰
6. **æ¢å¤æ‰§è¡Œ**ï¼šç³»ç»Ÿæ ¹æ®äººå·¥å†³ç­–ç»§ç»­è¿è¡Œæˆ–æ”¾å¼ƒè¯¥æ“ä½œã€‚

---

## ä¸‰ã€ä¸‰ç§äººå·¥å†³ç­–ç±»å‹

| å†³ç­–ç±»å‹          | è¯´æ˜       | ç¤ºä¾‹          |
| ------------- | -------- | ----------- |
| âœ… **approve** | æ‰¹å‡†æ“ä½œå¹¶æ‰§è¡Œ  | å‘é€é‚®ä»¶è‰ç¨¿åŸæ ·å‘é€  |
| âœï¸ **edit**   | ä¿®æ”¹å‚æ•°åå†æ‰§è¡Œ | æ”¹åŠ¨é‚®ä»¶æ”¶ä»¶äººåå†å‘é€ |
| âŒ **reject**  | æ‹’ç»æ‰§è¡Œå¹¶åé¦ˆ  | æ‹’ç»è‰ç¨¿å¹¶è¯´æ˜æ”¹è¿›å»ºè®® |

> æç¤ºï¼š
> ä¿®æ”¹å·¥å…·å‚æ•°ï¼ˆ`edit`ï¼‰æ—¶å»ºè®®å°å¹…è°ƒæ•´ã€‚è¿‡å¤§æ”¹åŠ¨å¯èƒ½å¯¼è‡´æ¨¡å‹é‡æ–°è§„åˆ’ï¼Œå¼•å‘å¤šæ¬¡æ‰§è¡Œæˆ–ä¸å¯é¢„æœŸè¡Œä¸ºã€‚

---

## å››ã€HITL é…ç½®ç¤ºä¾‹

åœ¨åˆ›å»º Agent æ—¶ï¼Œå°† `HumanInTheLoopMiddleware` æ·»åŠ åˆ° `middleware` åˆ—è¡¨ä¸­å³å¯å¯ç”¨ HITLã€‚
é€šè¿‡ `interrupt_on` å­—å…¸æ¥å®šä¹‰å“ªäº›å·¥å…·éœ€è¦äººå·¥å®¡æ‰¹ï¼Œä»¥åŠå…è®¸çš„å†³ç­–ç±»å‹ã€‚

```python
from langchain.agents import create_agent
from langchain.agents.middleware import HumanInTheLoopMiddleware
from langgraph.checkpoint.memory import InMemorySaver

agent = create_agent(
    model="openai:gpt-4o",
    tools=[write_file_tool, execute_sql_tool, read_data_tool],
    middleware=[
        HumanInTheLoopMiddleware(
            interrupt_on={
                "write_file": True,  # å…è®¸approve/edit/rejectä¸‰ç§æ“ä½œ
                "execute_sql": {"allowed_decisions": ["approve", "reject"]},  # ç¦æ­¢editä¿®æ”¹
                "read_data": False,  # å®‰å…¨æ“ä½œï¼Œä¸éœ€è¦äººå·¥å®¡æ‰¹
            },
            description_prefix="å·¥å…·è°ƒç”¨ç­‰å¾…äººå·¥å®¡æ‰¹",
        ),
    ],
    # HITL ä¾èµ–æ£€æŸ¥ç‚¹æœºåˆ¶æ¥åœ¨ä¸­æ–­åæ¢å¤çŠ¶æ€
    checkpointer=InMemorySaver(),  # æµ‹è¯•ç”¨å†…å­˜ä¿å­˜å™¨
)
```

> âš™ï¸ åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œè¯·ä½¿ç”¨æŒä¹…åŒ–çš„ä¿å­˜å™¨ï¼ˆå¦‚ `AsyncPostgresSaver`ï¼‰ä»¥ä¿è¯åœ¨æœåŠ¡é‡å¯åä»èƒ½æ¢å¤æ‰§è¡ŒçŠ¶æ€ã€‚
> è¯¦è§ LangGraph [Checkpoint æ–‡æ¡£](https://reference.langchain.com/python/langgraph/checkpoints/#langgraph.checkpoint.postgres.aio.AsyncPostgresSaver)ã€‚

---

## äº”ã€è§¦å‘ä¸­æ–­ä¸äººå·¥å®¡æŸ¥æµç¨‹

å½“ä½ è¿è¡Œ Agent æ—¶ï¼Œå®ƒä¼šä¸€ç›´æ‰§è¡Œï¼Œç›´åˆ°é‡åˆ°éœ€è¦äººå·¥å¹²é¢„çš„å·¥å…·è°ƒç”¨ã€‚
æ­¤æ—¶ï¼Œè¿”å›ç»“æœä¼šåŒ…å«ä¸€ä¸ª `__interrupt__` å­—æ®µï¼Œå…¶ä¸­åˆ—å‡ºæ‰€æœ‰å¾…å®¡æŸ¥çš„æ“ä½œã€‚

### ç¤ºä¾‹

```python
from langgraph.types import Command

config = {"configurable": {"thread_id": "user_session_001"}}

# è°ƒç”¨è§¦å‘æ½œåœ¨å±é™©æ“ä½œ
result = agent.invoke(
    {
        "messages": [
            {"role": "user", "content": "Delete old records from the database"}
        ]
    },
    config=config
)

print(result['__interrupt__'])
```

è¾“å‡ºä¸­æ–­è¯·æ±‚ï¼Œå†…å®¹ç±»ä¼¼ï¼š

```python
[
  Interrupt(
    value={
      "action_requests": [
        {
          "name": "execute_sql",
          "arguments": {"query": "DELETE FROM records WHERE created_at < NOW() - INTERVAL '30 days';"},
          "description": "å·¥å…·è°ƒç”¨ç­‰å¾…äººå·¥å®¡æ‰¹\n\nTool: execute_sql\nArgs: {...}"
        }
      ],
      "review_configs": [
        {
          "action_name": "execute_sql",
          "allowed_decisions": ["approve", "reject"]
        }
      ]
    }
  )
]
```

---

## å…­ã€æä¾›äººå·¥å†³ç­–ï¼ˆæ¢å¤æ‰§è¡Œï¼‰

æ‰§è¡Œè¢«ä¸­æ–­åï¼Œä½ å¯ä»¥ä½¿ç”¨ `Command(resume=...)` æä¾›äººå·¥å†³ç­–å¹¶æ¢å¤æµç¨‹ã€‚

### âœ… æ‰¹å‡†æ‰§è¡Œ

```python
agent.invoke(
    Command(
        resume={
            "decisions": [{"type": "approve"}]
        }
    ),
    config=config
)
```

---

### âœï¸ ä¿®æ”¹å‚æ•°åæ‰§è¡Œ

```python
agent.invoke(
    Command(
        resume={
            "decisions": [
                {
                    "type": "edit",
                    "edited_action": {
                        "name": "execute_sql",
                        "args": {"query": "DELETE FROM records WHERE created_at < NOW() - INTERVAL '60 days';"}
                    }
                }
            ]
        }
    ),
    config=config
)
```

---

### âŒ æ‹’ç»æ‰§è¡Œå¹¶æä¾›åé¦ˆ

```python
agent.invoke(
    Command(
        resume={
            "decisions": [
                {
                    "type": "reject",
                    "message": "ä¸å…è®¸åˆ é™¤æ•°æ®ï¼Œè¯·ä»…å½’æ¡£æ—§è®°å½•ã€‚"
                }
            ]
        }
    ),
    config=config
)
```

---

### å¤šä¸ªæ“ä½œåŒæ—¶ä¸­æ–­æ—¶

å¿…é¡»æŒ‰ä¸­æ–­è¯·æ±‚ä¸­æ“ä½œå‡ºç°çš„é¡ºåºä¾æ¬¡æä¾›å†³ç­–ï¼š

```python
{
  "decisions": [
    {"type": "approve"},
    {
      "type": "edit",
      "edited_action": {"name": "tool_name", "args": {"param": "new_value"}}
    },
    {
      "type": "reject",
      "message": "è¯¥æ“ä½œæœªè·æ‰¹å‡†"
    }
  ]
}
```

---

## ä¸ƒã€HITL æ‰§è¡Œç”Ÿå‘½å‘¨æœŸè¯¦è§£

1. Agent å‘æ¨¡å‹è¯·æ±‚å“åº”ã€‚
2. æ¨¡å‹è¿”å›åŒ…å«å·¥å…·è°ƒç”¨çš„å“åº”ã€‚
3. HITL ä¸­é—´ä»¶åœ¨ `after_model` é˜¶æ®µæ£€æŸ¥è¿™äº›è°ƒç”¨ã€‚
4. è‹¥å‘ç°éœ€è¦å®¡æŸ¥çš„æ“ä½œï¼Œæ„å»º `HITLRequest` å¹¶è§¦å‘ `interrupt`ã€‚
5. Agent æš‚åœï¼Œç­‰å¾…äººå·¥å®¡æŸ¥è¾“å…¥ã€‚
6. æ ¹æ®äººå·¥å†³ç­–ï¼š

   * æ‰§è¡Œæ‰¹å‡†æˆ–ä¿®æ”¹åçš„å·¥å…·è°ƒç”¨ï¼›
   * å¯¹æ‹’ç»çš„è°ƒç”¨ç”Ÿæˆåé¦ˆæ¶ˆæ¯ï¼›
   * æ¢å¤ç»§ç»­æ‰§è¡Œæ¨¡å‹æ¨ç†ã€‚

---

## å…«ã€è‡ªå®šä¹‰ HITL é€»è¾‘

å¦‚æœä½ å¸Œæœ›å®ç°æ›´å¤æ‚çš„äººæœºäº¤äº’æµç¨‹ï¼ˆä¾‹å¦‚å¤šçº§å®¡æ‰¹æˆ–æ¡ä»¶è§¦å‘ï¼‰ï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨ï¼š

* `interrupt` åŸè¯­ï¼ˆLangGraph æä¾›ï¼‰
* è‡ªå®šä¹‰ä¸­é—´ä»¶ï¼ˆç»§æ‰¿ `BaseMiddleware`ï¼‰

å¯å‚è€ƒ [LangChain Middleware æ–‡æ¡£](https://reference.langchain.com/python/langchain/middleware) äº†è§£æ‰©å±•æ–¹å¼ã€‚

---

## ä¹ã€æ€»ç»“

**Human-in-the-Loopï¼ˆHITLï¼‰** æ˜¯è®© AI å…·å¤‡â€œå¯æ§è‡ªæ²»â€çš„å…³é”®æœºåˆ¶ã€‚
å®ƒå¸¦æ¥çš„å¥½å¤„åŒ…æ‹¬ï¼š

* âœ… **å®‰å…¨æ€§**ï¼šé¿å…æ¨¡å‹è‡ªåŠ¨æ‰§è¡Œå±é™©æ“ä½œ
* ğŸ§  **å¯è§£é‡Šæ€§**ï¼šäººå·¥å®¡æŸ¥è¿‡ç¨‹æä¾›å†³ç­–ä¾æ®
* ğŸ”„ **å¯æ¢å¤æ€§**ï¼šé€šè¿‡ checkpoint èƒ½å®‰å…¨æš‚åœä¸ç»§ç»­æ‰§è¡Œ

æœªæ¥ï¼ŒHITL å°†æˆä¸ºä¼ä¸šçº§æ™ºèƒ½ä»£ç†ç³»ç»Ÿçš„æ ‡å‡†ç»„æˆéƒ¨åˆ†ï¼Œä½¿ AI æ—¢èƒ½è‡ªä¸»æ‰§è¡Œï¼Œåˆä¸å¤±äººç±»æŒæ§ã€‚

---

æ˜¯å¦å¸Œæœ›æˆ‘ç»§ç»­å†™ä¸€ç¯‡ã€Šå®æˆ˜ç¯‡ï¼šç”¨ HITL å®¡æŸ¥ SQL + æ–‡ä»¶å†™å…¥æ“ä½œã€‹çš„è¿›é˜¶æ•™ç¨‹ï¼Ÿæˆ‘å¯ä»¥å±•ç¤ºå®Œæ•´ä»£ç ä¸ä¸­æ–­å¤„ç†æµç¨‹ã€‚
